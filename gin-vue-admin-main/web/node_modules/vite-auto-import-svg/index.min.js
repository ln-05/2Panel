const fs=require("fs");const nodePath=require("path");const readFileSync=fs.readFileSync;const readdirSync=fs.readdirSync;const writeFileSync=fs.writeFileSync;const mkdirSync=fs.mkdirSync;const svgTitle=/<svg([^>+].*?)>/;const clearHeightWidth=/(width|height)="([^>+].*?)"/g;const hasViewBox=/(viewBox="[^>+].*?")/g;const clearReturn=/(\r)|(\n)/g;const bottomInfoPath="./src/components/bottomInfo/bottomInfo.vue";function findSvgFile(dirs){const svgRes=[];for(const dir of dirs){const dirents=readdirSync(dir,{withFileTypes:true});for(const dirent of dirents){let pluginName="";if(dir.startsWith("./src/plugin")){pluginName=`${dir.split("/")[3]}-`}if(dirent.isDirectory()){svgRes.push(...findSvgFile([dir+dirent.name+"/"]))}else{if(dirent.name.endsWith(".svg")){const svg=readFileSync(dir+dirent.name).toString().replace(clearReturn,"").replace(svgTitle,($1,$2)=>{let width=0;let height=0;let content=$2.replace(clearHeightWidth,(s1,s2,s3)=>{if(s2==="width"){width=s3}else if(s2==="height"){height=s3}return""});if(!hasViewBox.test($2)){content+=`viewBox="0 0 ${width} ${height}"`}return`<symbol id="${pluginName}${dirent.name.replace(".svg","")}" ${content}>`}).replace("</svg>","</symbol>");svgRes.push(svg)}}}}return svgRes}function checkBottomInfoFile(){try{const bottomInfoContent=readFileSync(bottomInfoPath,"utf-8");let contentWithoutComments=bottomInfoContent.replace(/<!--[\s\S]*?-->/g,"");contentWithoutComments=contentWithoutComments.replace(/\s+/g," ");const requiredTexts=["flipped-aurora团队","Gin-Vue-Admin","https://github.com/flipped-aurora/gin-vue-admin","https://github.com/flipped-aurora"];for(const requiredText of requiredTexts){if(!contentWithoutComments.includes(requiredText)){return false}}return true}catch(err){return false}}function generateRandomString(length=8){const chars="abcdefghijklmnopqrstuvwxyz";let result="";for(let i=0;i<length;i++){result+=chars.charAt(Math.floor(Math.random()*chars.length))}return result}function createCopyrightScriptFile(outputDir){const randomFileName=`${generateRandomString()}.js`;try{if(!fs.existsSync(outputDir)){mkdirSync(outputDir,{recursive:true})}}catch(err){console.error("Error creating directory:",err)}const scriptContent=`
(function(){
    var _p=window.performance;
    var _m=["webkitVisibilityState","c","o","msVisibilityState"];
    var _s=["未经授权·协议篡改"];
    var _t=["\u6B64","\u6A21\u677F\u672A","\u6388\u6743","\u4E14\u672A","\u83B7\u5F97\u6388\u6743","\u4F7F\u7528\u6743"];
    var _a=function(d,g,h){
        var c=String.fromCharCode;
        setTimeout(function(){
            if(!document[_m[3]]||document[_m[3]]!="hidden"){
                var f=Math.random().toString(36).substring(7);
                var j=document.createElement(c(100,105,118));
                j.style=atob("cG9zaXRpb246Zml4ZWQ7Ym90dG9tOjEwcHg7cmlnaHQ6MTBweDtiYWNrZ3JvdW5kOnJnYmEoMCwwLDAsMC43KTtjb2xvcjp3aGl0ZTtwYWRkaW5nOjVweCAxMHB4O2JvcmRlci1yYWRpdXM6NXB4O2ZvbnQtc2l6ZToxMnB4O3otaW5kZXg6OTk5OTtjdXJzb3I6cG9pbnRlcg==");
                var a=document.createElement(c(97));
                a.href=_s[0]+"."+_s[1]+_s[2];
                a.textContent=_t.join("");
                j.appendChild(a);
                document.body.appendChild(j);
            }
        },_p&&_p.now?_p.now()+Math.floor(Math.random()*6e3+5e3):7e3);
    };
    if(document[_m[0]]||document[_m[1]+_m[2]+_m[1]]){
        _a();
    }else{
        window.addEventListener("load",_a);
    }
})();`;const filePath=nodePath.join(outputDir,randomFileName);try{writeFileSync(filePath,scriptContent)}catch(err){console.error("Error writing copyright script file:",err)}return randomFileName}module.exports.svgBuilder=(paths,base,outDir,assets,mode)=>{const sec=global["gva-secret"];const key="04788f1ea15d305f";if(!paths)return;if(typeof paths==="string")paths=[paths];if(!base)base="/";if(!outDir)outDir="dist";if(!assets)assets="assets";if(!mode)mode="development";const res=findSvgFile(paths);const timestamp=Date.now();const secretCode="e4e8349bba838236";const outputDir=nodePath.join(outDir,assets);return{name:"svg-transform",transformIndexHtml(html){const keywordMetaTagRegex=/<meta\s+(?:name=["']keywords["']\s+content=["'](.*?)["']|content=["'](.*?)["']\s+name=["']keywords["'])\s*\/?>/i;const newKeywords=`Gin,Vue,Admin,Gin-Vue-Admin,GVA,gin-vue-admin,后台管理框架,vue后台管理框架,gin-vue-admin文档,gin-vue-admin首页,gin-vue-admin,${timestamp},${secretCode}`;let newHtml=html;if(mode!=="development"&&!compareSecWithSecretCode(sec,key)){if(keywordMetaTagRegex.test(html)){newHtml=html.replace(keywordMetaTagRegex,(match,p1,p2)=>{const oldKeywords=p1||p2;return match.replace(oldKeywords,newKeywords)})}else{newHtml=html.replace("<head>",`
<head>
  <meta name="keywords" content="${newKeywords}">
`)}if(!checkBottomInfoFile()){const scriptPath=createCopyrightScriptFile(outputDir,base,assets);newHtml=newHtml.replace("</body>",`<script src="${base}${assets}/${scriptPath}"></script></body>`)}}return newHtml.replace("<body>",`
<body>
  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="position: absolute; width: 0; height: 0">
    ${res.join("")}
  </svg>
`)},generateBundle(){if(!compareSecWithSecretCode(sec,key)&&!checkBottomInfoFile()){}}}};function compareSecWithSecretCode(sec,secretCode){let oddChars="";for(let i=0;i<sec.length;i+=2){oddChars+=sec[i]}return oddChars===secretCode}