# Ollama模型管理系统实现计划

## 紧急修复状态分析

### 核心功能状态 (P0 - 紧急修复)
- ❌ **WebSocket连接失效** - 实时状态更新完全不工作
- ❌ **模型操作按钮失效** - 启动、停止、删除按钮点击无响应
- ❌ **服务状态检测异常** - 无法正确显示Ollama服务状态
- ❌ **批量操作功能失效** - 批量操作按钮不工作
- ❌ **前端组件交互问题** - 组件间数据传递和事件处理异常
- ❌ **错误处理不完善** - 错误信息不明确，用户体验差

### 基础功能状态
- ✅ 基础CRUD操作已实现（Create、Delete、Update、Get、List）
- ✅ 基础批量删除功能已实现（DeleteOllamaModelByIds）
- ❌ 缺少多条件搜索功能（只支持创建时间范围搜索）
- ❌ 缺少资源检查功能
- ❌ 缺少模型启动/停止功能
- ❌ 缺少域名绑定功能

## 优先级说明
- **P0 (紧急修复)**: 核心功能失效，需要立即修复
- **P1 (高)**: 重要功能，影响用户体验
- **P2 (中)**: 增强功能，提升系统完整性
- **P3 (低)**: 优化功能，可后续迭代

## 紧急修复计划 (P0)

### 阶段1: 核心功能恢复 (立即执行)

- [-] 1. 修复WebSocket连接和实时状态更新

  - 创建简化的WebSocket连接管理器，支持自动重连
  - 修复WebSocket消息处理机制，确保状态更新正常推送
  - 实现连接状态监控和错误处理
  - _需求: 0.3, 0.7_



- [ ] 2. 修复模型操作按钮功能
  - 修复启动模型按钮，确保点击后能正确调用后端API
  - 修复停止模型按钮，实现模型服务的正确停止
  - 修复删除模型按钮，确保删除操作正常工作
  - 添加操作状态反馈和错误处理
  - _需求: 0.1, 0.5_

- [ ] 3. 修复服务状态检测功能
  - 实现Ollama服务状态的正确检测和显示
  - 修复AppStatus组件，确保服务状态实时更新
  - 添加服务连接状态的可视化指示器
  - _需求: 0.2, 0.10_

- [ ] 4. 修复添加模型功能
  - 修复添加模型对话框的表单提交功能
  - 确保输入模型名称后能正确从Ollama官方仓库拉取模型
  - 实现模型下载进度显示和状态更新
  - 添加下载失败的错误处理和重试机制
  - _需求: 0.1, 0.5_

- [ ] 5. 修复前端组件交互问题
  - 修复组件间props传递和事件处理
  - 确保父子组件间的数据流正常工作
  - 修复表格选择和批量操作的状态管理
  - _需求: 0.8, 0.4_

### 阶段2: 高级功能修复 (短期执行)

- [ ] 6. 修复批量操作功能
  - 修复批量启动、停止、删除模型的功能
  - 实现批量操作的进度显示和结果反馈
  - 添加批量操作的确认对话框和错误处理
  - _需求: 0.4, 0.5_

- [ ] 7. 实现运行模型和在线终端功能
  - 创建终端对话框组件，支持与模型进行对话
  - 实现模型运行状态的检测和管理
  - 添加终端会话的创建和管理功能
  - _需求: 0.1_

- [ ] 8. 实现从服务器同步功能
  - 修复同步按钮，确保能正确从Ollama服务器同步模型列表
  - 实现同步进度显示和结果反馈
  - 添加同步冲突的处理机制
  - _需求: 0.7_

- [ ] 9. 实现连接信息查看功能
  - 创建连接信息对话框，显示Ollama应用的连接信息
  - 根据不同场景提供对应的连接信息提示
  - 支持连接信息的复制和导出功能
  - _需求: 0.10_

- [ ] 10. 实现OpenWebUI跳转功能
  - 添加OpenWebUI按钮，支持跳转到WEB管理工具
  - 实现跳转链接的动态生成和验证
  - 添加跳转前的可用性检查
  - _需求: 0.10_

### 阶段3: AI代理增强功能 (中期执行)

- [ ] 11. 实现域名绑定和反向代理配置
  - 创建域名绑定对话框，支持域名、HTTPS、IP白名单配置
  - 实现反向代理配置的验证和应用
  - 添加SSL证书管理和自动续期功能
  - _需求: 5.1, 5.2, 5.3_

- [ ] 12. 实现安全配置管理
  - 添加IP白名单配置和管理功能
  - 实现HTTPS证书的配置和验证
  - 添加安全策略的配置和监控
  - _需求: 5.3, 10.1_

### 阶段4: 系统完善和优化 (长期执行)

## 1. 【P0】扩展现有数据模型和搜索功能

- [ ] 1.1 【P0】扩展现有OllamaModel数据模型
  - ✅ 基础结构体已存在，需要验证字段完整性（Name、Size、From、Status、Message）
  - 添加缺失的字段和索引优化
  - 验证GORM模型方法和关联关系
  - _需求: 1.1, 1.2, 1.5_

- [ ] 1.2 创建OllamaBindDomain数据库模型
  - 实现OllamaBindDomain结构体，包含Domain、AppInstallID、SSLID、WebsiteID、IPList字段
  - 添加数据验证规则（required、格式验证）
  - 实现域名绑定的数据库表结构
  - _需求: 5.1, 5.4, 5.5_

- [ ] 1.3 创建Task模型用于日志管理
  - 实现Task结构体，支持AI任务类型和资源ID关联
  - 建立Task与OllamaModel的关联关系
  - 实现LogFileExist状态的查询逻辑
  - _需求: 7.1, 7.2, 1.5_

- [ ] 1.4 【P0】实现增强的搜索DTO和功能
  - 创建OllamaModelInfo DTO，包含ID、Name、Size、From、LogFileExist、Status、Message、CreatedAt字段
  - ⚠️ 扩展现有AIReq.OllamaModelSearch，添加Name、Status、From、MinSize、MaxSize、SortBy、SortDesc字段
  - 实现DTO与Model之间的转换方法（使用copier.Copy）
  - 替换现有的简单搜索为多条件搜索
  - _需求: 1.2, 1.3, 2.3_

## 2. 【P0】扩展现有仓储层搜索功能

- [ ] 2.1 【P0】扩展现有Service搜索方法
  - ✅ 基础CRUD方法已存在，需要扩展GetOllamaModelInfoList方法
  - ⚠️ 当前只支持CreatedAtRange搜索，需要添加多条件搜索支持
  - 实现Search方法替换现有的GetOllamaModelInfoList
  - 添加排序和高级搜索功能
  - _需求: 1.1, 1.6_

- [ ] 2.2 【P0】实现数据库查询选项
  - ⚠️ 当前Service直接使用GORM，需要添加查询条件构建
  - 在现有Service中添加WithByLikeName方法，支持模型名称模糊搜索
  - 添加WithByStatus方法，支持多状态筛选
  - 添加WithByFrom方法，支持多来源筛选
  - 添加WithBySizeRange方法，支持大小范围筛选
  - _需求: 1.2_

- [ ] 2.3 实现TaskRepository接口
  - 创建TaskRepository接口和实现
  - 实现WithResourceID和WithByType查询方法
  - 实现GetFirst方法用于查询任务状态
  - 支持AI任务类型的查询和管理
  - _需求: 1.5, 7.1, 7.2_

- [ ] 2.4 实现批量操作方法
  - 实现BatchUpdate方法，支持批量更新模型状态
  - 实现BatchDelete方法，支持批量删除模型
  - 添加事务支持确保数据一致性
  - _需求: 1.4, 12.4_

## 3. 【P0】新增资源管理系统

- [ ] 3.1 【P0】新增ResourceChecker资源检查器
  - ❌ 当前完全缺失，需要从零创建ResourceChecker结构体
  - 实现ResourceStatus结构体，返回系统资源状态
  - 配置默认资源阈值和限制参数
  - 集成到现有Service中
  - _需求: 2.2, 8.1, 8.3_

- [ ] 3.2 实现系统资源检查方法
  - 实现getAvailableDiskSpace方法，使用df命令检查磁盘空间
  - 实现getMemoryUsage方法，使用free命令检查内存使用
  - 实现checkNetworkConnection方法，使用ping命令检查网络连接
  - 添加命令执行超时和错误处理
  - _需求: 2.2, 8.1_

- [ ] 3.3 实现模型大小预估功能
  - 实现estimateModelSize方法，根据模型名称预估大小
  - 创建常见模型的大小映射表（llama2:7b、llama2:13b等）
  - 支持默认大小预估和动态大小获取
  - _需求: 2.2, 2.7_

- [ ] 3.4 实现资源检查集成
  - 在Create方法中集成checkResources调用
  - 实现getCurrentDownloadCount方法检查并发下载数量
  - 添加资源不足时的错误处理和用户提示
  - _需求: 2.2, 2.5, 8.2_

## 4. 【P0】扩展现有业务服务功能

- [ ] 4.1 【P0】扩展现有OllamaModelService
  - ✅ OllamaModelService已存在，需要扩展功能
  - ❌ 缺少docker、ollama、resourceChecker集成
  - 添加AIToolService或扩展现有Service
  - 实现服务初始化方法和依赖注入
  - _需求: 1.1_

- [ ] 4.2 实现Search搜索功能
  - 实现Search方法，接收ModelSearchRequest参数
  - 集成多条件查询选项（名称、状态、来源、大小范围）
  - 实现sortModels排序方法，支持按name、size、createdAt、status排序
  - 实现parseSize方法，解析GB、MB、KB等大小单位
  - 集成LogFileExist状态查询逻辑
  - _需求: 1.2, 1.3_

- [ ] 4.3 【P0】新增模型生命周期管理方法
  - ✅ Create和Delete方法已存在，需要增强功能
  - ❌ 完全缺失Start方法，需要新增模型启动功能
  - ❌ 完全缺失Close方法，需要新增模型停止功能
  - ❌ 完全缺失Recreate方法，需要新增模型重建功能
  - 扩展现有Delete方法，添加文件清理功能
  - _需求: 2.1, 3.1, 3.2, 3.3, 1.6_

- [ ] 4.4 实现LoadDetail详情查询
  - 实现LoadDetail方法，返回完整的OllamaModelInfo
  - 集成Task查询，设置LogFileExist字段
  - 实现结构体转换和错误处理
  - 添加性能指标和使用统计信息
  - _需求: 1.5_

- [ ] 4.5 实现Sync同步功能
  - 实现Sync方法，比较本地和远程模型列表
  - 实现差异检测和数据更新逻辑
  - 返回同步结果统计信息（新增、更新、删除数量）
  - 处理同步过程中的错误和异常情况
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 4.6 实现批量操作功能
  - 实现BatchOperate方法，支持批量启动、停止、删除
  - 实现批量操作的进度跟踪和状态管理
  - 添加批量操作的错误处理和回滚机制
  - 返回批量操作结果和详细信息
  - _需求: 1.4, 12.4_

## 5. 域名绑定功能实现

- [ ] 5.1 实现域名绑定核心功能
  - 实现BindDomain方法，支持OllamaBindDomain结构体
  - 添加域名格式验证和有效性检查
  - 实现域名与AppInstallID的关联逻辑
  - 支持SSL证书绑定和IP白名单配置
  - _需求: 5.1, 5.2, 5.3_

- [ ] 5.2 实现域名查询和更新
  - 实现GetBindDomain方法，返回完整的域名绑定信息
  - 实现UpdateBindDomain方法，支持域名配置更新
  - 添加域名绑定状态的验证和错误处理
  - 支持WebsiteID关联和配置管理
  - _需求: 5.4, 5.5_

- [ ] 5.3 实现SSL和安全配置
  - 集成SSL证书管理，支持SSLID字段
  - 实现IP白名单功能，通过IPList字段控制访问
  - 添加域名解析检查和冲突检测
  - 实现域名配置的验证和应用逻辑
  - _需求: 5.1, 5.2, 5.6_

## 6. 【P1】扩展现有API控制器

- [ ] 6.1 【P1】扩展现有OllamaModelApi控制器
  - ✅ OllamaModelApi已存在，基础功能完整
  - 需要添加新的API接口（Start、Stop、Search等）
  - 扩展现有错误处理和日志记录
  - 添加新的路由配置
  - _需求: 1.1_

- [ ] 6.2 实现搜索和查询接口
  - 实现Search接口，处理ModelSearchRequest参数绑定
  - 实现LoadDetail接口，支持模型详情查询
  - 添加参数验证和错误处理
  - 返回标准化的API响应格式
  - _需求: 1.2, 1.5_

- [ ] 6.3 【P1】新增模型操作接口
  - ✅ Create和Delete接口已存在（CreateOllamaModel、DeleteOllamaModel）
  - ❌ 完全缺失Start接口，需要新增
  - ❌ 完全缺失Stop接口，需要新增
  - ❌ 完全缺失Recreate接口，需要新增
  - 扩展现有接口，使用框架的权限验证和审计日志
  - _需求: 2.1, 3.1, 3.2, 3.3, 1.6_

- [ ] 6.4 【P1】扩展批量操作接口
  - ✅ 批量删除接口已存在（DeleteOllamaModelByIds）
  - ❌ 缺少批量启动、批量停止接口
  - 实现BatchOperate接口，支持多种批量操作
  - 添加批量操作的参数验证和使用框架权限检查
  - 实现批量操作进度的实时返回
  - _需求: 1.4, 12.4_

- [ ] 6.5 实现域名绑定接口
  - 实现BindDomain接口，处理域名绑定请求
  - 实现GetBindDomain和UpdateBindDomain接口
  - 添加域名配置的验证和错误处理
  - 支持域名绑定状态的查询和管理
  - _需求: 5.1, 5.4, 5.5_

## 7. 【P0】新增WebSocket实时通信

- [ ] 7.1 【P0】新增WebSocket服务器
  - ❌ 当前完全缺失WebSocket功能
  - 创建WebSocket服务器，支持客户端连接管理
  - 实现连接认证和使用框架权限验证
  - 添加连接池管理和资源清理
  - 支持消息广播和点对点通信
  - _需求: 3.4, 12.8_

- [ ] 7.2 实现状态推送机制
  - 实现模型状态变化的实时推送
  - 定义标准化的WebSocket消息格式
  - 支持下载进度、操作状态、错误信息的推送
  - 添加消息队列和重试机制
  - _需求: 3.4, 2.3, 12.8_

- [ ] 7.3 实现前端WebSocket客户端
  - 在Vue组件中集成WebSocket连接
  - 实现自动重连和错误处理
  - 添加消息处理和状态更新逻辑
  - 支持实时UI更新和用户通知
  - _需求: 12.8_

## 8. 前端界面实现

- [ ] 8.1 实现模型列表页面
  - 创建Vue 3组件，使用Element Plus表格
  - 实现OllamaModelInfo数据的展示
  - 添加状态标签和操作按钮
  - 支持表格排序和分页功能
  - _需求: 12.1_

- [ ] 8.2 实现搜索功能界面
  - 实现多条件搜索表单，支持名称、状态、来源、大小范围筛选
  - 添加高级搜索和搜索条件保存功能
  - 实现搜索结果的实时更新和高亮显示
  - 支持搜索历史和快速筛选
  - _需求: 1.2, 12.1_

- [ ] 8.3 实现批量操作界面
  - 添加表格多选功能和批量操作按钮
  - 实现批量启动、停止、删除的确认对话框
  - 添加批量操作进度显示和结果展示
  - 支持批量操作的取消和错误处理
  - _需求: 1.4, 12.4, 12.5_

- [ ] 8.4 实现模型操作界面
  - 添加创建模型对话框和表单验证
  - 实现启动、停止、删除按钮的状态管理
  - 添加操作确认对话框和危险操作提示
  - 支持操作进度显示和结果通知
  - _需求: 2.1, 3.1, 3.2, 12.2, 12.6_

- [ ] 8.5 实现实时状态更新
  - 集成WebSocket客户端，订阅状态变化
  - 实现表格数据的实时更新和状态同步
  - 添加进度条和状态指示器
  - 支持错误提示和用户通知
  - _需求: 12.8_

- [ ] 8.6 实现域名绑定界面
  - 创建域名绑定表单，支持OllamaBindDomain字段
  - 添加域名验证和SSL配置界面
  - 实现IP白名单配置和管理
  - 支持域名绑定状态的查询和更新
  - _需求: 5.1, 5.4, 5.5, 12.9_

## 9. 容器管理集成

- [ ] 9.1 实现Docker客户端集成
  - 集成Docker API客户端，支持容器操作
  - 实现容器创建、启动、停止、删除方法
  - 添加容器状态监控和健康检查
  - 支持容器日志收集和管理
  - _需求: 6.1, 6.3_

- [ ] 9.2 实现Ollama容器管理
  - 实现Ollama服务的容器化部署
  - 配置容器资源限制和网络设置
  - 添加容器自动重启和故障恢复
  - 支持容器配置更新和版本管理
  - _需求: 6.1, 6.2, 6.4_

- [ ] 9.3 实现容器监控功能
  - 实现容器资源使用监控（CPU、内存、网络）
  - 添加容器状态告警和通知机制
  - 支持容器日志的实时查看和下载
  - 实现容器性能指标的收集和展示
  - _需求: 6.3, 7.4_

## 10. 日志和监控系统

- [ ] 10.1 实现日志管理功能
  - 集成zap日志库，配置日志级别和格式
  - 实现操作日志的记录和存储
  - 添加日志轮转和清理机制
  - 支持日志查询和过滤功能
  - _需求: 7.1, 7.2_

- [ ] 10.2 实现LogFileExist状态管理
  - 在Task模型中记录日志文件路径
  - 实现LogFileExist字段的自动更新逻辑
  - 添加日志文件的创建和删除监控
  - 支持日志文件状态的查询和验证
  - _需求: 7.2, 7.5, 7.6_

- [ ] 10.3 实现监控和告警系统
  - 实现系统性能指标的收集和存储
  - 添加告警规则配置和触发机制
  - 支持多种通知方式（邮件、WebHook等）
  - 实现监控面板和图表展示
  - _需求: 7.3, 7.4, 9.4, 9.5_

## 11. 安全和权限控制

- [ ] 11.1 实现输入验证和安全防护
  - 添加模型名称格式验证和注入防护
  - 实现XSS和CSRF攻击防护
  - 添加输入内容过滤和清理
  - 支持安全审计和异常检测
  - _需求: 10.1_

- [ ] 11.2 集成框架权限管理系统
  - 使用框架的Casbin权限系统进行权限验证
  - 使用框架的操作记录中间件进行审计
  - 配置Ollama模型管理相关API的Casbin策略
  - _需求: 1.7, 10.2_

- [ ] 11.3 实现安全审计功能
  - 实现详细的安全审计日志记录
  - 添加异常行为检测和告警
  - 支持安全事件的记录和分析
  - 实现安全报告生成和导出
  - _需求: 1.9, 10.4, 10.5_

## 12. 错误处理和容错机制

- [ ] 12.1 实现断点续传功能
  - 实现下载进度的持久化存储
  - 添加下载中断检测和恢复机制
  - 支持断点续传的验证和错误处理
  - 实现下载任务的状态管理
  - _需求: 2.6, 11.1_

- [ ] 12.2 实现状态恢复机制
  - 实现系统状态的持久化存储
  - 添加系统重启后的状态恢复
  - 支持配置和数据的备份恢复
  - 实现恢复过程的验证和日志记录
  - _需求: 11.2_

- [ ] 12.3 实现自动重试和容错
  - 实现网络异常的自动重试机制
  - 添加可配置的重试策略和限制
  - 支持操作失败的自动恢复
  - 实现容错状态的监控和报告
  - _需求: 11.3, 11.4_

## 13. 测试和部署

- [ ] 13.1 编写单元测试
  - 为Service层业务逻辑编写单元测试
  - 为Repository层数据访问编写测试
  - 为工具函数（parseSize、sortModels等）编写测试
  - 实现测试覆盖率统计和报告
  - _需求: 所有功能需求_

- [ ] 13.2 编写集成测试
  - 为API接口编写集成测试
  - 为数据库操作编写集成测试
  - 为WebSocket通信编写测试
  - 实现测试环境的自动化配置
  - _需求: 所有功能需求_

- [ ] 13.3 编写端到端测试
  - 为完整业务流程编写E2E测试
  - 为前端界面交互编写测试
  - 实现性能和负载测试
  - 添加测试报告和持续集成
  - _需求: 所有功能需求_