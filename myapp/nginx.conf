events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;
    
    # åŸºæœ¬è®¾ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶
    client_max_body_size 100M;
    
    # ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
    upstream myapp_api {
        server myapp:8889;
    }
    
    # HTTPæœåŠ¡å™¨é…ç½®
    server {
        listen 80;
        server_name 14.103.149.197 localhost;
        
        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # APIä»£ç†
        location /api/ {
            proxy_pass http://myapp_api/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # ç¼“å†²è®¾ç½®
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }
        
        # é»˜è®¤é¡µé¢
        location / {
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>MyApp Database Management</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>MyApp Database Management API</h1>
        <div class="status success">
            <strong>âœ… Service Status:</strong> Running
        </div>
        <div class="status info">
            <strong>ğŸ“¡ API Endpoints:</strong>
            <ul>
                <li>GET /api/database/list - è·å–æ•°æ®åº“åˆ—è¡¨</li>
                <li>POST /api/database/create - åˆ›å»ºæ•°æ®åº“è¿æ¥</li>
                <li>POST /api/database/update - æ›´æ–°æ•°æ®åº“è¿æ¥</li>
                <li>POST /api/database/deleted - åˆ é™¤æ•°æ®åº“è¿æ¥</li>
                <li>POST /api/database/test - æµ‹è¯•æ•°æ®åº“è¿æ¥</li>
                <li>POST /api/database/sync - åŒæ­¥æ•°æ®åº“é…ç½®</li>
            </ul>
        </div>
        <div class="status info">
            <strong>ğŸ”— Test API:</strong>
            <a href="/api/database/list" target="_blank">Test Database List API</a>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }
    }
}